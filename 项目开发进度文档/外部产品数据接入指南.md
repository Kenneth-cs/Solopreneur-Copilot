# 外部产品数据接入指南

> 适用场景：你已有其他上线产品（网站、小程序、SaaS 工具等），希望将这些产品的核心指标（MRR、DAU、收入、成本）上报到「超级个体」营销看板统一展示。

---

## 一、接入前准备

### 1.1 在「项目管理」中为你的产品创建对应项目

登录系统后，前往「项目管理」→「新建项目」，为每个要接入的外部产品创建一个项目记录。

创建完成后，在浏览器地址栏或通过 API 获取该项目的 `projectId`（数据库自增 ID）。

### 1.2 获取 API Token（当前版本用 Cookie Session）

当前版本使用 NextAuth.js Session 鉴权，适合在同域前端直接调用。  
如需服务端跨域上报，暂时有两种方案：

| 方案 | 适用场景 | 复杂度 |
|------|---------|--------|
| **方案 A（推荐）**：使用专属 API Key | 服务端脚本、定时任务、跨域上报 | 中等（待开发） |
| **方案 B**：服务端登录获取 Cookie | 自动化脚本、测试环境 | 较高 |

> ⚠️ API Key 功能规划中，当前可用方案 B 或手动录入。

---

## 二、数据上报 API

### 2.1 接口地址

```
POST https://your-domain.com/api/metrics
```

### 2.2 请求头

```http
Content-Type: application/json
Cookie: next-auth.session-token=<your_session_cookie>
```

### 2.3 请求体（JSON）

```json
{
  "projectId": "clxxxxxxxxxxxxx",
  "mrr": 1200,
  "dau": 340,
  "revenue": 50.00,
  "cost": 12.00,
  "ltv": 0
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `projectId` | string | ✅ | 在「项目管理」里创建项目后获取 |
| `mrr` | number | ✅ | 月经常性收入（元），当月累计值 |
| `dau` | number | ✅ | 今日活跃用户数 |
| `revenue` | number | ✅ | 今日实际收入（元） |
| `cost` | number | ✅ | 今日成本支出（元，含服务器/API费用等） |
| `ltv` | number | ❌ | 用户生命价值，选填 |

### 2.4 成功响应

```json
{
  "id": "clxxxxx",
  "projectId": "clxxxxx",
  "date": "2026-02-27T00:00:00.000Z",
  "mrr": 1200,
  "dau": 340,
  "revenue": 50,
  "cost": 12,
  "ltv": 0
}
```

> 同一天同一项目重复上报会自动覆盖（upsert），不会重复计算。

---

## 三、常见接入方式

### 3.1 手动录入（最简单，当前可用）

在「仪表盘」首页点击右上角「录入今日指标」按钮，手动填写数据。

适合：每日数据量不大、产品还在早期阶段。

---

### 3.2 服务端定时脚本（Node.js 示例）

适合：有独立后端服务、希望每日自动上报。

```javascript
// sync-metrics.js  —  每天 23:50 执行一次
const axios = require('axios');

async function reportMetrics() {
  // 从你的数据库/Stripe/第三方平台拉取今日数据
  const todayStats = await getMyProductStats();

  await axios.post('https://your-solopreneur-domain.com/api/metrics', {
    projectId: 'clxxxxxxxxxxxxx',  // 替换为你的 projectId
    mrr: todayStats.mrr,
    dau: todayStats.activeUsers,
    revenue: todayStats.todayRevenue,
    cost: todayStats.todayCost,
  }, {
    headers: {
      'Content-Type': 'application/json',
      // 临时方案：从浏览器复制 session cookie
      'Cookie': 'next-auth.session-token=xxxxx'
    }
  });

  console.log('指标上报成功');
}

reportMetrics();
```

---

### 3.3 Stripe Webhook 自动同步（推荐，待开发）

适合：使用 Stripe 收款的 SaaS 产品，订阅数据自动同步。

**数据流：**
```
Stripe 事件 → Webhook → 解析 charge/subscription → POST /api/metrics
```

**关键 Stripe 事件：**

| 事件 | 含义 | 对应字段 |
|------|------|---------|
| `invoice.payment_succeeded` | 订阅付款成功 | `revenue` |
| `customer.subscription.updated` | MRR 变化 | `mrr` |
| `charge.refunded` | 退款 | `revenue` 减少 |

**实现计划（待开发）：**
1. 创建 `/api/webhooks/stripe` 接收 Stripe 推送
2. 验证 `stripe-signature` 防伪造
3. 解析事件，自动 upsert 对应项目的今日 metrics

---

### 3.4 前端埋点上报 DAU（JavaScript 片段）

适合：统计页面真实活跃用户，集成到你的前端产品。

```javascript
// 在你的产品前端加入以下代码（用户登录后触发）
async function reportDAU() {
  const today = new Date().toDateString();
  const lastReport = localStorage.getItem('dau_reported');
  
  // 每天只上报一次
  if (lastReport === today) return;
  
  try {
    await fetch('https://your-solopreneur-domain.com/api/metrics', {
      method: 'POST',
      credentials: 'include',  // 携带 session cookie（同域）
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        projectId: 'clxxxxxxxxxxxxx',
        dau: 1,          // 每次 +1，后端会 upsert（需后端改为累加模式）
        mrr: 0,
        revenue: 0,
        cost: 0,
      }),
    });
    localStorage.setItem('dau_reported', today);
  } catch (e) {
    console.warn('DAU 上报失败', e);
  }
}

// 用户成功登录时调用
reportDAU();
```

> **注意**：当前 `/api/metrics` 是覆盖写入，DAU 累加功能需要后端配合改造（在后续版本支持 `dau_increment` 模式）。

---

### 3.5 Google Analytics 数据导入（计划中）

适合：已在用 GA4 统计 DAU 的产品，通过 GA Data API 自动拉取。

**计划实现：**
1. 在设置页绑定 GA4 Property ID
2. 每日定时任务通过 Google Data API v1 拉取活跃用户数
3. 自动写入对应项目的 `dau` 字段

---

## 四、字段说明与最佳实践

### MRR 的计算方式

```
月经常性收入 MRR = 所有付费订阅用户 × 月均订阅金额
```

- 如果是一次性收费产品，MRR = 当月总收入
- 如果是年付订阅，折算为月均值：年付金额 ÷ 12
- 建议每月初更新一次 MRR，每日更新 revenue（当日流水）

### 成本录入建议

| 成本类型 | 录入频率 | 建议 |
|---------|---------|------|
| 服务器/云服务 | 月末录入 | 按月平摊到每天 = 月账单 ÷ 30 |
| AI API 调用费 | 每日 | 从 API 控制台查看每日用量 |
| 域名/SSL | 年末录入 | 年费 ÷ 365 |
| 广告投放 | 每日 | 从广告平台导出 |

---

## 五、后续规划

| 功能 | 状态 | 预计时间 |
|------|------|---------|
| 专属 API Key 生成（免 Cookie） | 📋 计划中 | 下一阶段 |
| Stripe Webhook 自动同步 | 📋 计划中 | 下一阶段 |
| Google Analytics DAU 自动拉取 | 📋 计划中 | 下一阶段 |
| DAU 累加模式（埋点友好） | 📋 计划中 | 下一阶段 |
| 多产品对比图表 | 📋 计划中 | 营销看板接真实数据时 |

---

*文档更新时间：2026-02-27*  
*当前版本：Solopreneur Copilot v0.1*
